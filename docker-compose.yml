# ─── LoopyMart Docker Compose ────────────────────────────────────────────────
# Services:
#   mariadb   — user/auth SQL store
#   mongo     — all app data (cart, orders, wishlists, …)
#   backend   — FastAPI on :8001 (internal only)
#   nginx     — Vue SPA + reverse-proxy on :80 (public)
#   ollama    — LLM for AI chat challenge (opt-in: --profile llm)
#
# Quick start:
#   cp backend/flags.example.yml backend/flags.yml   # optional — set real flags
#   cp .env.example .env                             # optional — override defaults
#   podman-compose up --build
#
# With Ollama (LLM challenge):
#   podman-compose --profile llm up --build

services:

  # ── MariaDB ──────────────────────────────────────────────────────────────────
  mariadb:
    image: mariadb:11
    restart: unless-stopped
    environment:
      MARIADB_USER: loopymart
      MARIADB_PASSWORD: ${MARIADB_PASSWORD:-loopymart_dev}
      MARIADB_DATABASE: loopymart
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-root_dev}
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL",
             "mariadb-admin ping -u loopymart -p${MARIADB_PASSWORD:-loopymart_dev} --silent"]
      interval: 5s
      timeout: 5s
      retries: 15

  # ── MongoDB ─────────────────────────────────────────────────────────────────
  mongo:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ── FastAPI Backend ─────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
      mongo:
        condition: service_healthy
    environment:
      # ── Database connections (use Docker service names as hostnames) ──
      DATABASE_URL: mysql+aiomysql://loopymart:${MARIADB_PASSWORD:-loopymart_dev}@mariadb:3306/loopymart
      MONGODB_URL: mongodb://mongo:27017
      MONGODB_DB_NAME: loopymart

      # ── App secrets — CHANGE IN PRODUCTION ──
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 10080

      # ── Seed admin account ──
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@loopymart.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      ADMIN_NAME: ${ADMIN_NAME:-Admin}

      # ── CORS ──
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost,http://localhost:80}

      # ── Ollama (LLM chat challenge) ──
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-mistral}

      # ── Optional Razorpay payment gateway ──
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-}

    volumes:
      # flags.yml MUST exist on the host before starting.
      # Run: cp backend/flags.example.yml backend/flags.yml
      # If missing, the app falls back to flags.example.yml (example flag values).
      - ./backend/flags.yml:/app/flags.yml:ro

      # Persist user-uploaded images across container restarts
      - uploads_data:/app/static/uploads

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      start_period: 60s
      retries: 8

  # ── nginx (Vue SPA + Reverse Proxy) ─────────────────────────────────────────
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${HTTP_PORT:-80}:80"

  # ── Ollama (opt-in: podman-compose --profile llm up) ──────────────────────
  ollama:
    image: ollama/ollama
    profiles: ["llm"]
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    # Uncomment to expose Ollama outside the Docker network (e.g. for local dev):
    # ports:
    #   - "11434:11434"

volumes:
  mariadb_data:
  mongo_data:
  uploads_data:
  ollama_data:
